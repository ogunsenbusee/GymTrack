@using System.Text.Json
@model GymTrack.Services.WorkoutAiRequest

@{
    ViewData["Title"] = "AI Coach";
    var ok = ViewBag.Ok as bool?;
    var error = ViewBag.Error as string;
    var pretty = ViewBag.PrettyJson as string;
    string rawJson = ViewBag.RawJson as string ?? "";
    JsonElement? meta = null;
    JsonElement? notes = null;

    try
    {
        meta = (JsonElement?)ViewBag.Meta;
        notes = (JsonElement?)ViewBag.Notes;
    }
    catch { }
}

<h2 class="mb-3">AI Coach - Antrenman Planı</h2>

<form asp-action="Index" method="post" class="mt-2">
    @Html.AntiForgeryToken()

    <div class="mb-2">
        <label class="form-label">Boy (cm)</label>
        <input asp-for="HeightCm" class="form-control" />
    </div>

    <div class="mb-2">
        <label class="form-label">Kilo (kg)</label>
        <input asp-for="WeightKg" class="form-control" />
    </div>

    <div class="mb-2">
        <label class="form-label">Hedef</label>
        <input asp-for="Goal" class="form-control" />
    </div>

    <div class="mb-2">
        <label class="form-label">Seviye</label>
        <input asp-for="Level" class="form-control" />
    </div>

    <div class="mb-2">
        <label class="form-label">Haftada Kaç Gün</label>
        <input asp-for="DaysPerWeek" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Ekipman</label>
        <input asp-for="Equipment" class="form-control" />
    </div>

    <button class="btn btn-primary" type="submit">Plan Üret</button>
</form>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger mt-3">
        <b>Hata:</b> @error
    </div>
}

@if (ok == true)
{
    <hr class="my-4" />

    <div class="d-flex align-items-center justify-content-between">
        <h4 class="mb-0">Özet</h4>

        <form asp-action="DownloadJson" method="post" class="ms-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="json" value="@rawJson" />
            <button class="btn btn-outline-secondary">JSON indir</button>
        </form>
    </div>

    <div class="mt-3">
        @if (meta.HasValue)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Meta</h5>
                    <ul class="mb-0">
                        <li><b>Süre:</b> @(meta.Value.TryGetProperty("sure", out var s) ? s.ToString() : "-")</li>
                        <li><b>Hedef:</b> @(meta.Value.TryGetProperty("hedef", out var h) ? h.ToString() : "-")</li>
                        <li><b>Seviye:</b> @(meta.Value.TryGetProperty("seviye", out var sev) ? sev.ToString() : "-")</li>
                        <li><b>Frekans:</b> @(meta.Value.TryGetProperty("frekans", out var f) ? f.ToString() : "-")</li>
                        <li><b>Ekipman:</b> @(meta.Value.TryGetProperty("ekipman", out var e) ? e.ToString() : "-")</li>
                    </ul>
                </div>
            </div>
        }

        @if (notes.HasValue && notes.Value.ValueKind == JsonValueKind.Array)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Notlar</h5>
                    <ul class="mb-0">
                        @foreach (var n in notes.Value.EnumerateArray())
                        {
                            <li>@n.ToString()</li>
                        }
                    </ul>
                </div>
            </div>
        }
    </div>

    <h4 class="mt-4">Üretilen Plan (JSON)</h4>
    <pre style="white-space:pre-wrap; background:#111; color:#eee; padding:12px; border-radius:8px;">@pretty</pre>
}
